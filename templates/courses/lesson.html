{% extends 'base.html' %}
{% load static %}
{% load markdown_extras %}

{% block title %}{{ content.title }} - {{ content.module.course.title }}{% endblock %}

{% block content %}
<div class="row g-0 min-vh-100">
    <!-- Sidebar (Course Navigation) -->
    <div class="col-lg-3 bg-white border-end d-none d-lg-block"
        style="height: 100vh; position: sticky; top: 0; overflow-y: auto;">
        <div class="p-4 border-bottom">
            <h6 class="text-uppercase text-muted small fw-bold mb-2">Curso</h6>
            <h5 class="fw-bold text-primary"><a href="{% url 'courses:detail' content.module.course.slug %}"
                    class="text-decoration-none">{{ content.module.course.title }}</a></h5>
            <div class="progress mt-3" style="height: 6px;">
                <!-- Calculated in view, but simple placeholder here if needed -->
                <div class="progress-bar bg-success" style="width: 50%"></div>
            </div>
        </div>

        <div class="accordion accordion-flush" id="lessonSidebar">
            {% for module in content.module.course.modules.all %}
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button {% if module != content.module %}collapsed{% endif %} fw-bold small"
                        type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMod{{ module.id }}">
                        {{ module.title }}
                    </button>
                </h2>
                <div id="sidebarMod{{ module.id }}"
                    class="accordion-collapse collapse {% if module == content.module %}show{% endif %}"
                    data-bs-parent="#lessonSidebar">
                    <div class="accordion-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for c in module.contents.all %}
                            <li
                                class="list-group-item list-group-item-action border-0 px-4 py-3 {% if c == content %}bg-primary bg-opacity-10 text-primary border-start border-4 border-primary{% endif %}">
                                <a href="{% url 'courses:lesson' content.module.course.slug c.id %}"
                                    class="text-decoration-none {% if c == content %}fw-bold text-primary{% else %}text-muted{% endif %} d-flex align-items-center">
                                    <i
                                        class="bi {% if c.video_url %}bi-play-circle{% else %}bi-file-text{% endif %} me-2"></i>
                                    {{ c.title }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 bg-light">
        <div class="container py-5 px-lg-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'courses:list' %}">Cursos</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'courses:detail' content.module.course.slug %}">{{
                            content.module.course.title }}</a></li>
                    <li class="breadcrumb-item active">{{ content.module.title }}</li>
                </ol>
            </nav>

            <div class="card shadow-sm border-0 rounded-4 overflow-hidden mb-5">
                <div class="card-body p-5">
                    <h1 class="fw-bold mb-4">{{ content.title }}</h1>

                    {% if content.video_url %}
                    <div class="ratio ratio-16x9 mb-4 rounded-3 overflow-hidden shadow">
                        <iframe src="https://www.youtube.com/embed/{{ youtube_id }}" title="YouTube video"
                            allowfullscreen></iframe>
                    </div>
                    {% endif %}

                    <div class="typography">
                        {% if content.text %}
                        {{ content.text|markdown|safe }}
                        {% else %}
                        <p class="text-muted fst-italic">Nenhum conteúdo de texto disponível para esta aula.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white p-4 border-top">
                    <form method="post" class="d-flex justify-content-between align-items-center">
                        {% csrf_token %}
                        {% if already_completed %}
                        <button type="button" class="btn btn-success disabled rounded-pill px-4">
                            <i class="bi bi-check-circle-fill me-2"></i>Concluído
                        </button>
                        {% else %}
                        <button type="submit" name="complete_lesson"
                            class="btn btn-primary btn-lg rounded-pill px-5 shadow">
                            Marcar como Concluído (+10 JC)
                        </button>
                        {% endif %}

                        {% if credits_earned %}
                        <span class="text-success fw-bold animate__animated animate__fadeInUp">
                            <i class="bi bi-lightning-fill"></i> +10 JetCredits ganhos!
                        </span>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Gamification / Comments Placeholder -->
            <div class="alert alert-info border-0 shadow-sm rounded-3 d-flex align-items-center">
                <i class="bi bi-lightbulb-fill fs-3 me-3"></i>
                <div>
                    <h6 class="fw-bold mb-1">Dica de Mestre</h6>
                    <p class="mb-0 small">Complete todas as aulas deste módulo para desbloquear o Quiz e ganhar um bônus
                        de 50 JC!</p>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Content Typography */
    .typography h1,
    .typography h2,
    .typography h3 {
        font-weight: 700;
        margin-top: 1.5rem;
        color: var(--text-main);
    }

    .typography p {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #4b5563;
        margin-bottom: 1.5rem;
    }

    .typography ul,
    .typography ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }

    .typography li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    .typography code {
        background: #f3f4f6;
        color: #ef4444;
        padding: 0.2rem 0.4rem;
        rounded: 4px;
    }

    .typography pre {
        background: #1f2937;
        color: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
    }

    .typography blockquote {
        border-left: 4px solid var(--primary);
        padding-left: 1rem;
        font-style: italic;
        color: #6b7280;
    }
</style>
{% endblock %}